!--------------------------------------------------
!- Monday, May 15, 2017 12:17:46 AM
!- Import of : 
!- c:\src\zelch128\prg.u - d bases.prg
!- Commodore 128 BASIC 7/7.1
!--------------------------------------------------
30000 SYS15625:REM ============ TRANSFER BASE MODULE V1.0 ========== 10/20/90 =
30010 ON(W1-200)GOTO30100,30500,32100,32600,33000,33900,35000,35100,35300:GOTO940
30100 GOSUB990:IFM3$<>"*"THENU1=ASC(M3$)-192:GOSUB31200:GOTO940
30200 O$=T$(65):GOSUB4:DO:POKE2831,1:GOSUB8:LOOPUNTILA$=R$OR(ASC(A$)>192ANDASC(A$)<213):O$=A$:GOSUB4:IFA$=R$THEN920:ELSEW1=ASC(A$)-192
30300 OPEN2,D(1,0),2,STR$(D(1,1))+":sys.u/d bases":RECORD#2,W1:FORI=1TO4:SYS8222:NEXTI:CLOSE2:IFMID$(I$,ASC(U$(5))-192,1)="1"THENU1=W1:GOSUB31200:GOTO940
30400 O$=T$(66):GOSUB4:GOTO920
30500 W1=1:GOSUB990:IFM3$<>"*"THENW1=ASC(M3$)-192
30600 W2=20:GOSUB990:IFM3$<>"*"THENW2=ASC(M3$)-192
30700 GOSUB30800:GOTO940
30800 OPEN2,D(1,0),2,STR$(D(1,1))+":sys.u/d bases":O$=R$:GOSUB9:C$="":W3$="":X=W1-1:DO:X=X+1:RECORD#2,X:SYS8222:SYS8222:SYS8222:W1$=I$:SYS8222:W2$=I$
30900 O$="{ct c}":A$=CHR$(X+192):IFMID$(W2$,ASC(U$(5))-192,1)="1"THENO$="{black}"+A$+") "+W1$
31000 IFX=U1THENO$=O$+" {white}*"
31100 GOSUB4:GOSUB8:LOOPUNTILX=W2ORA$=" ":CLOSE2:RETURN
31200 OPEN2,D(1,0),2,STR$(D(1,1))+":sys.u/d bases":RECORD#2,U1:INPUT#2,D(8,0):INPUT#2,D(8,1):SYS8222:M6$=I$:SYS8222:SYS8222:U2$=I$:M7$=CHR$(192+U1)
31300 SYS8222:U2=VAL(I$):SYS8222:U3=VAL(I$):CLOSE2:O$=T$(67):GOSUB4:F$="sys.u/d "+CHR$(U1+64)+" title":U=D(8,0):D=D(8,1):GOSUB26:RETURN
31400 W2=16:GOSUB990:W1$="":IFM3$="#"THENW2=15:W1$=CHR$(U1+192):GOTO31600:ELSEIFM3$="*"THENFORI=1TO3:GOSUB990:NEXTI:GOTO31600
31500 F$=M3$:GOSUB990:I=VAL(M3$):GOSUB990:U=VAL(M3$):GOSUB990:D=VAL(M3$):RETURN
31600 O$=T$(68):GOSUB4:POKE2831,1:POKE2847,W2:POKE2895,1:GOSUB6:FORI=1TO6:IFINSTR(I$,MID$("*?:,$"+CHR$(34),I,1))THENI$=""
31700 NEXTI:IFI$=""THENF$="":RETURN
31800 U=D(8,0):D=D(8,1):FORI=1TOLEN(I$):A$=MID$(I$,I,1):IFASC(A$)>192ANDASC(A$)<219THENMID$(I$,I,1)=CHR$(ASC(A$)-128)
31900 NEXTI:F$=W1$+I$:O$=T$(69):GOSUB4:C$="PSW"+R$:GOSUB28:O$=A$:GOSUB4:RETURN
32000 OPEN1,U,15:OPEN2,U,2,STR$(D)+":"+F$+","+MID$("psp",I,1)+",r":INPUT#1,E,E$:CLOSE1:CLOSE2:RETURN
32100 GOSUB31400:IFF$=""ORI=4THEN920:ELSEGOSUB32000:IFE<>62THEN920:ELSEGOSUB35400:IFXTHEN32500:ELSEO$=T$(70):GOSUB4
32200 GOSUB35600:IFETHENO$=T$(71):GOSUB4:GOTO32500:ELSEGOSUB32000:IFE<>0THEN32400
32300 OPEN2,U,0,"$"+STR$(D)+":"+F$:SYS8225:W1=PEEK(2854)+256*PEEK(2855):W2=PEEK(2856)+256*PEEK(2857):CLOSE2:IFW1>0ANDW2>U2THENU(1)=INT(U(1)+(W1*U3)):GOTO32500
32400 O$=T$(72):GOSUB4:OPEN1,U,15,"s"+STR$(D)+":"+F$:PRINT#1,"v":INPUT#1,I:CLOSE1
32500 IFO(1)=1THENO(1)=0:GOTO600:ELSE940
32600 GOSUB31400:IFF$=""ORI=4THEN920:ELSEGOSUB32000:IFETHEN920
32700 OPEN2,U,0,"$"+STR$(D)+":"+F$:SYS8225:W1=PEEK(2854)+256*PEEK(2855):CLOSE2:CLOSE1:IFU(1)<W1THENO$=T$(73):GOSUB4:GOTO920
32800 GOSUB35400:IFXTHEN32500:ELSEO$=T$(74):GOSUB4:GOSUB35700:IFETHENO$=T$(71):GOSUB4:GOTO32500
32900 U(1)=U(1)-W1:GOTO32500
33000 GOSUB35400:IFXTHEN32500:W1$=CHR$(U1+192)
33100 O$=T$(75):GOSUB4:TI$="000000":U=D(8,0):D=D(8,1)
33200 GET#5,A$:GETB$:IFA$="{ct x}"ORB$="{ct x}"ORVAL(TI$)>40THENO$=T$(71):GOSUB4:GOTO920:ELSEIFA$<>"{ct i}"THEN33200
33300 F$="":TI$="000000":IFPEEK(2827)THEN600
33400 GET#5,A$:GETB$:IFA$="{ct x}"ORB$="{ct x}"ORVAL(TI$)>40THENO$=T$(71):GOSUB4:GOTO33800:ELSEIFA$="{ct i}"ORA$=""THEN33400:ELSEIFA$="{ct d}"THEN32500
33500 IFA$=CHR$(13)THENI=INSTR("psw",RIGHT$(F$,1)):F$=W1$+LEFT$(F$,LEN(F$)-2):GOSUB35600:GOTO33600:ELSEF$=F$+A$:GOTO33400
33600 GOSUB32000:IFE>0THEN33800
33700 OPEN2,U,0,"$"+STR$(D)+":"+F$:SYS8225:W1=PEEK(2854)+256*PEEK(2855):W2=PEEK(2856)+256*PEEK(2857):CLOSE2:IFW1>0ANDW2>U2THENU(1)=INT(U(1)+(W1*U3)):GOTO33300
33800 O$=T$(72):GOSUB4:OPEN1,U,15,"s"+STR$(D)+":"+F$:PRINT#1,"v":INPUT#1,I:CLOSE1:GOTO32500
33900 CLOSE1:CLOSE2:W1=0:W2=15:W4=0:O$=T$(76):GOSUB4:W1$=CHR$(U1+192)
34000 O$="{ct k}{black}File #"+STR$(W1+1)+"{ct c}":GOSUB4:GOSUB31600:IFF$<>""ANDI<>4THEN34100:ELSEW2=0:IFW1=0THEN920:ELSEGOSUB35400:GOTO34400
34100 GOSUB32000:IFE>0THENO$="{ct k}{black}ERROR: "+E$:GOSUB4:GOTO34000
34200 OPEN2,U,0,"$"+STR$(D)+":"+F$:SYS8225:W3=PEEK(2854)+256*PEEK(2855):CLOSE2:W4=W4+W3:IFW4>U(1)THENO$=T$(73):GOSUB4:GOTO34000
34300 W1=W1+1:TT$(W1+50)=STR$(W4):TT$(W1)=F$+","+MID$("psw",I,1):IFW1=50THENO$="{ct k}{black}You have reached the maximum number of files.":GOSUB4:ELSE34000
34400 IFXTHEN34900:ELSEO$=T$(77):GOSUB4:SLEEP20:W2=1
34500 F$=LEFT$(TT$(W2),LEN(TT$(W2))-2):I=INSTR("psw",RIGHT$(TT$(W2),1)):A$=F$+","+MID$("psp",I,1):SLEEP2:IFLEFT$(A$,1)>192THENA$=RIGHT$(A$,LEN(A$)-1)
34600 PRINT#5,"{ct i*11}";A$:GOSUB35700:IFE=1THENPRINT#5,"{ct i*7}{ct d*6}":GOTO34900
34700 IFW2=W1THENPRINT#5,"{ct i*7}{ct d*6}":O$="Transfer complete!":GOSUB4:U(1)=U(1)-VAL(TT$(W2+50)):GOTO34900
34800 U(1)=U(1)-VAL(TT$(W2+50)):W2=W2+1:GOTO34500
34900 FORI=0TO50:TT$(I)="":TT$(I+50)="":NEXTI:A=FRE(1):GOTO32500
35000 IFMID$(U$(7),ASC(U2$)-192,1)="1"THEN940:ELSE920
35100 OPEN2,D(8,0),0,"$"+STR$(D(8,1))+":zu%=99":SYS8225:W1=PEEK(2854)+256*PEEK(2855):CLOSE2:O$="{ct k}{black}Commodore blocks:"+STR$(W1):GOSUB4
35200 O$="{black}Kilobytes free  :"+STR$(INT(W1/4))+"{ct k}":GOSUB4:GOTO940
35300 O(12)=1:O(10)=0:F$="sys.u/d "+CHR$(U1+64)+" title":U=D(8,0):D=D(8,1):GOSUB8330:O(8)=50:GOSUB1010:GOTO940
35400 X=0:O$=T$(78):GOSUB4:DO:POKE2831,1:GOSUB8:LOOPUNTILINSTR("XL"+R$,A$):A=INSTR("XL"+R$,A$)
35450 IFA=1THENO$=T$(71):GOSUB4:X=1:RETURN
35500 IFA=2THENO$="{black}Auto{sh space}logoff set!":GOSUB4:O(1)=1:RETURN:ELSERETURN
35600 PRINT"{clear}{yellow}{ct n}Upload: {white}"F$","+MID$("psp",I,1):GOTO500
35700 PRINT"{clear}{yellow}{ct n}Download: {white}"F$","+MID$("psp",I,1):GOTO550
55555 OPEN1,8,15,"s0:prg.u/d bases":CLOSE1:SAVE"prg.u/d bases",8
