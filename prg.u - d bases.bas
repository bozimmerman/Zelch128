!--------------------------------------------------
!- Tuesday, May 16, 2017 10:32:07 PM
!- Import of : 
!- c:\src\zelch128next\prg.u - d bases.prg
!- Unknown Machine
!--------------------------------------------------
30000 SYS15625:REM ============ TRANSFER BASE MODULE V1.0 ========== 07/26/91 =
30010 ON(W1-200)GOTO30100,30500,32100,32600,33000,33900,35000,35100,35300,36000,37000,38000:GOTO940
30020 OPEN2,D(1,0),2,MID$(STR$(D(1,1)),2)+":sys.u/d bases":RETURN
30030 E=0:IFDR$(1)=""ORUB(4)=0ORASC(LEFT$(F$,1))<192THENE=-1:RETURN:ELSEA$=LEFT$(F$,1)
30035 Y=0:A=Y:FORX=1TO12:IFINSTR(DR$(X),".")THENY=1
30040 W7=INSTR(DR$(X),A$):D0=W7:IFW7THENDO:W7=INSTR(MID$(DR$(X),D0+1),A$):D0=W7+D0:A=A+1:LOOPUNTILW7=0
30045 NEXTX:IFA>UB(4)ORY=0THENO$=T$(109):GOSUB4:E=1:A=0:Y=0:RETURN:ELSEUB$(8)="":RETURN
30050 IFDR$(1)=""ORUB(4)=0ORASC(LEFT$(F$,1))<192THENRETURN:ELSEGOSUB400:A$=LEFT$(F$,1):OPEN2,D(10,0),2,MID$(STR$(D(10,1)),2)+":sys.u/d desc"
30055 X=1:DO:A=INSTR(DR$(X),"."):IFATHENMID$(DR$(X),A,1)=A$:RECORD#2,X:PRINT#2,DR$(X):RECORD#2,((X-1)*120)+A+12:PRINT#2,F$+R$+STR$(ID)+R$+O$(3)+R$+UB$(8):EXIT
30060 X=X+1:LOOPUNTILX=13:CLOSE2:RETURN
30070 IFDR$(1)=""ORUB(4)=0ORASC(LEFT$(F$,1))<192THENRETURN
30073 A$=LEFT$(F$,1):OPEN2,D(10,0),2,MID$(STR$(D(10,1)),2)+":sys.u/d desc":X=1:DO:W7=INSTR(DR$(X),A$):A=W7
30075 IFW7=0THEN30080:ELSERECORD#2,((X-1)*120)+A+12:SYS8222:IFI$=F$THENGOSUB30090:EXIT:ELSEW7=INSTR(MID$(DR$(X),A+1),A$):A=W7+A:GOTO30075
30080 X=X+1:LOOPUNTILX=13:CLOSE2:RETURN
30090 SYS8222:O$="{ct k}{yellow}Uploaded by: {white}"+UI$(VAL(I$))+"{yellow} (ID#{white}"+I$+"{yellow})":GOSUB4:SYS8222:O$="{yellow}    Sent on: {white}"+I$:GOSUB4:SYS8222:O$="{yellow}{ct k}>{white}"+I$:GOTO4
30100 GOSUB760:IFI>0ANDI<27THENW1=I:GOSUB30300:GOTO940
30200 O$=T$(65):GOSUB770:IFI=0THEN920:ELSEW1=I
30300 GOSUB30020:RECORD#2,W1:FORI=1TO4:SYS8222:NEXTI:CLOSE2
30350 IFMID$(I$,ASC(U$(5))-192,1)="1"THENUB(1)=W1:O$=O$(10)+":UD"+CHR$(UB(1)+192):GOSUB7:GOSUB31200:GOTO940
30400 O$=T$(66):GOSUB4:GOTO920
30500 W1=1:GOSUB760:W0$=LEFT$(SY$,1):IFI>0ANDI<27THENW1=I
30600 W2=26:GOSUB760:IFI>=W1ANDI<27THENW2=I
30700 GOSUB30800:GOTO940
30800 GOSUB30020:O$=R$:GOSUB9:C$="":W3$="":X=W1-1:DO:X=X+1:RECORD#2,X:SYS8222:SYS8222:SYS8222:W1$=I$:SYS8222:W2$=I$
30900 O$="{ct c}":A$=CHR$(X+192):IFW0$="#"THENA$=RIGHT$(STR$(X),2)
30950 IFMID$(W2$,ASC(U$(5))-192,1)="1"THENO$="{black}"+A$+") "+W1$
31000 IFX=UB(1)THENO$=O$+" {white}*"
31100 GOSUB4:GOSUB8:LOOPUNTILX=W2ORA$=" ":CLOSE2:RETURN
31200 GOSUB30020:RECORD#2,UB(1):INPUT#2,D(8,0):INPUT#2,D(8,1):SYS8222:UB$(1)=I$:SYS8222:SYS8222:UB$(9)=I$:UB$(2)=CHR$(192+UB(1))
31250 IFMID$(U$(8),4,1)="1"ORINSTR(";"+UB$(9)+";",";"+MID$(STR$(ID),2)+";")THENUB$(9)="{sh @}":ELSEUB$(9)=""
31300 SYS8222:UB(2)=VAL(I$):SYS8222:UB(3)=VAL(I$):SYS8222:UB(4)=VAL(I$):CLOSE2
31350 O$=T$(67):GOSUB4:F$="sys.u/d "+CHR$(UB(1)+64)+" title":U=D(8,0):D=D(8,1):GOSUB26:RETURN
31400 W2=16:GOSUB990:W1$="":E=0:IFSY$="#"THENW2=15:W1$=CHR$(UB(1)+192):E=1:U=D(8,0):D=D(8,1):FORI=1TO3:GOSUB990:NEXT:GOTO31450
31420 IFSY$<>"*"THENI$=SY$:GOTO31500
31450 O$=T$(68):GOSUB4:X=W2:GOSUB16:FORI=1TO6:IFINSTR(I$,MID$("*?:,$"+CHR$(34),I,1))THENI$=""
31470 NEXTI:IFI$=""THENF$="":Y=4:GOTO31800
31500 FORI=1TOLEN(I$):A$=MID$(I$,I,1):IFASC(A$)>192ANDASC(A$)<219THENMID$(I$,I,1)=CHR$(ASC(A$)AND127)
31550 NEXTI:F$=W1$+I$
31600 IFE=0THENGOSUB990:IFSY$<>"*"THENY=VAL(SY$):GOTO31700
31650 O$=T$(69):GOSUB4:C$="PSW"+R$:GOSUB28:Y=I:IFI=4THEN31800
31700 IFETHEN31800:ELSEGOSUB8010
31800 I=Y:E=0:RETURN
31900 GOSUB990:IFSY$<>"*"THENGOSUB990:GOSUB990:U=D(8,0):D=D(8,1):I$=CHR$(192+UB(1)):RETURN:ELSEGOSUB990:U=VAL(SY$):GOSUB990:D=VAL(SY$):I$="":RETURN
31950 O$="{ct k}ERROR: "+E$:GOSUB4:GOTO32500
32000 E=0:OPEN1,U,15:OPEN2,U,2,MID$(STR$(D),2)+":"+F$+","+MID$("psp",I,1)+",r":INPUT#1,E,E$:GET#2,A$:IFST>0ANDE=0THENE=63
32010 CLOSE2:CLOSE1:RETURN
32050 OPEN2,U,0,"$"+MID$(STR$(D),2)+":"+F$:SYS8225:W1=PEEK(2854)+256*PEEK(2855):RETURN
32100 GOSUB31400:IFF$=""ORI=4THEN920:ELSEGOSUB32000:IFE<>62THEN31950
32150 GOSUB30030:IFE>0THEN920:ELSEIFE=0THENO$=T$(110):GOSUB4:X=80:GOSUB5:UB$(8)=I$
32170 GOSUB35400:IFXTHEN32500:ELSEO$=T$(70):GOSUB4
32200 GOSUB35600:SLEEP5:IFETHENO$=T$(71):GOSUB4:GOTO32500:ELSEGOSUB32000:IFETHEN32400
32300 GOSUB32050:W2=PEEK(2856)+256*PEEK(2857):CLOSE2:IFW1>0ANDW2>UB(2)THENU(1)=INT(U(1)+(W1*UB(3))):GOSUB30050:GOTO32500
32400 O$=T$(72):GOSUB4:OPEN1,U,15,"s"+MID$(STR$(D),2)+":"+F$:CLOSE1
32500 IFO(1)=1THENO(1)=0:GOTO600:ELSE940
32600 GOSUB31400:IFF$=""ORI=4THEN920:ELSEGOSUB32000:IFETHEN31950
32700 GOSUB32050:CLOSE2:CLOSE1:IFU(1)<W1THENO$=T$(73):GOSUB4:GOTO920
32800 GOSUB30070:GOSUB35400:IFXTHEN32500:ELSEO$=T$(74):GOSUB4:GOSUB35700:IFETHENO$=T$(71):GOSUB4:GOTO32500
32900 U(1)=U(1)-W1:GOTO32500
33000 GOSUB31900:W1$=I$:GOSUB35400:IFXTHEN32500:ELSEO$=T$(75):GOSUB4
33100 TI$="000000"
33200 GET#5,A$:GETB$:IFA$="{ct x}"ORB$="{ct x}"ORVAL(TI$)>40THENO$=T$(71):GOSUB4:GOTO920:ELSEIFA$<>"{ct i}"THEN33200
33300 F$="":TI$="000000":IFPEEK(2827)THEN600
33400 GET#5,A$:GETB$:IFA$="{ct x}"ORB$="{ct x}"ORVAL(TI$)>40THENO$=T$(71):GOSUB4:GOTO920:ELSEIFA$="{ct i}"ORA$=""THEN33400:ELSEIFA$="{ct d}"THEN33910
33500 IFA$<>R$THENF$=F$+A$:GOTO33400:ELSEIFINSTR(F$,",")=(LEN(F$)-1)THENI=INSTR("psw",RIGHT$(F$,1)):F$=W1$+LEFT$(F$,LEN(F$)-2):GOTO33550:ELSE32500
33550 GOSUB32000:IFE=0ORE=63THEN32500:ELSEGOSUB30030:IFETHEN32500
33600 GOSUB35600:GOSUB32000:IFETHEN32400
33700 GOSUB32050:W2=PEEK(2856)+256*PEEK(2857):CLOSE2:IFW1>0ANDW2>UB(2)THENU(1)=INT(U(1)+(W1*UB(3))):GOSUB30050:GOTO33100:ELSE32400
33900 W2=0:W4=0:GOSUB31900:W2$=I$:GOSUB8640:O$=T$(76):GOSUB4:OPEN1,U,15:OPEN2,U,0,"$"+MID$(STR$(D),2)+":"+W2$+W1$:GET#2,A$:GET#2,A$:SYS8258:O$="":GOSUB4
34000 I=0:POKE253,0:SYS8258:IFPEEK(254)THEN34350:ELSEW5$=I$:IFASC(LEFT$(I$,1))>192THENW5$=MID$(W5$,2)
34100 O$="{cyan}"+W5$+" {white}(Y/N/D/A)? {ct c}":GOSUB4:C$="YNDA":GOSUB28:ONIGOTO34200,34000:GOTO34350
34200 W3=PEEK(2975)+256*PEEK(2976):W4=W4+W3:IFW4>U(1)THENO$=T$(73):GOSUB4:CLOSE2:CLOSE1:GOTO920
34300 W2=W2+1:TT$(W2+50)=STR$(W3):TT$(W2)=I$:IFW2>49THENO$=T$(111):GOSUB4:GOTO34350:ELSE34000
34350 CLOSE2:CLOSE1:IFW2=0ORI=4THENO$=T$(112):GOSUB4:GOTO920
34400 GOSUB35400:IFXTHEN34800:ELSEO$=T$(77):GOSUB4:SLEEP15:W3=1
34500 W5$=TT$(W3):F$=LEFT$(W5$,LEN(W5$)-2):I=INSTR("psr",RIGHT$(W5$,1)):SLEEP1:IFASC(LEFT$(W5$,1))>192THENW5$=MID$(W5$,2)
34600 X=1:DO:PRINT#5,MID$("{ct i*12}"+W5$,X,1);:X=X+1:LOOPUNTILX>LEN(W5$)+12:PRINT#5,R$;:SLEEP2:GOSUB35700:IFETHEN34900
34700 U(1)=U(1)-VAL(TT$(W3+50)):SLEEP2:IFW3<W2THENW3=W3+1:GOTO34500:ELSEPRINT#5,"{ct i*9}{ct d*9}":SLEEP3:O$=T$(113):GOSUB4
34800 FORI=0TO100:TT$(I)="":NEXTI:A=FRE(1):GOTO32500
34900 PRINT#5,"{ct i*9}{ct d*11}":SLEEP5:O$=T$(114):GOSUB4:GOTO34800
35000 IFUB$(9)="{sh @}"THEN940:ELSE920
35100 U=D(8,0):D=D(8,1):F$="zu%":GOSUB32050:CLOSE2:O$="{ct k}{black}Commodore blocks:"+STR$(W1):GOSUB4
35200 O$="{black}Kilobytes free  :"+STR$(INT(W1/4)):GOSUB4
35250 O$="{black}Xmodem blocks   :"+STR$(INT(W1*2))+"{ct k}":GOSUB4:GOTO940
35300 O(12)=1:O(10)=0:F$="sys.u/d "+CHR$(UB(1)+64)+" title":U=D(8,0):D=D(8,1):GOSUB8330:O(8)=50:GOSUB1010:GOTO940
35400 X=0:O$=T$(78):GOSUB4:DO:POKE2831,1:GOSUB8:LOOPUNTILINSTR("XL"+R$,A$):A=INSTR("XL"+R$,A$)
35450 IFA=1THENO$=T$(71):GOSUB4:X=1:RETURN
35500 IFA=2THENO$=T$(115):GOSUB4:O(1)=1:RETURN:ELSERETURN
35600 PRINT"{clear}{yellow}{ct n}Upload: {white}"F$","+MID$("psp",I,1):O$="    Upload: "+F$:GOSUB7:GOTO500
35700 PRINT"{clear}{yellow}{ct n}Download: {white}"F$","+MID$("psp",I,1):O$="    Download: "+F$:GOSUB7:GOTO550
36000 GOSUB990:A=VAL(SY$):IFSY$="*"ORSY$="#"THEN36100
36010 IFA=0ANDO(19)<>0THENBLOAD"p-xfer 1300",U(D(0,0)),D(D(0,1)):O(19)=0:O$(23)="Punter"
36020 IFA=1ANDO(19)<>1THENBLOAD"x-xfer 1300",U(D(0,0)),D(D(0,1)):O(19)=1:O$(23)="Xmodem"
36030 GOTO940
36100 IFSY$="#"THENA=ABS(O(19)-1):GOTO36010
36110 IFSY$="*"THENO$=T$(116):GOSUB4
36120 C$="PX"+R$:GOSUB28:IFI=3THEN920:ELSEA=I-1:GOTO36010
37000 IFDR$(1)=""THEN920:ELSEO$=T$(117):GOSUB4:FORI=0TO200:TT$(I)="":NEXTI:W0=UB(1):W9=UB(4)
37010 OPEN3,D(1,0),3,MID$(STR$(D(1,1)),2)+":sys.u/d bases":UB(1)=1
37050 RECORD#3,UB(1):W1$=CHR$(192+UB(1)):L=1:INPUT#3,I$:IFVAL(I$)<8THEN37500
37055 U=VAL(I$):INPUT#3,D:INPUT#3,I$:INPUT#3,I$:IFVAL(I$)=0THEN37500
37057 FORI=1TO4:INPUT#3,I$:NEXTI:UB(4)=VAL(I$):IFUB(4)=0THEN37500
37060 OPEN2,U,0,"$"+MID$(STR$(D),2)+":"+W1$+"*":GET#2,A$:GET#2,A$:SYS8258
37070 POKE253,0:SYS8258:IFPEEK(254)=0THENTT$(L)=LEFT$(I$,LEN(I$)-2):L=L+1:GOTO37070:ELSECLOSE2
37080 OPEN2,D(10,0),2,MID$(STR$(D(10,1)),2)+":sys.u/d desc":IFL=1THEN37200
37090 FORW1=1TO12:W7=INSTR(DR$(W1),W1$):X=W7
37100 IFW7=0THEN37150:ELSERECORD#2,((W1-1)*120)+X+12:SYS8222
37110 W5=0:FORY=1TOL-1:IFI$=TT$(Y)THENTT$(Y)="":W5=1
37120 NEXTY:IFW5=0THENMID$(DR$(W1),X,1)=".":RECORD#2,W1:PRINT#2,DR$(W1)
37130 W7=INSTR(MID$(DR$(W1),X+1),W1$):X=W7+X:GOTO37100
37150 NEXTW1:UB$(8)=""
37200 CLOSE2:IFL=1THEN37500:ELSEFORY=1TOL-1:IFTT$(Y)<>""THENF$=TT$(Y):GOSUB30050
37210 TT$(Y)="":NEXTY
37500 UB(1)=UB(1)+1:IFUB(1)<27THEN37050:ELSECLOSE2:CLOSE3:FORI=0TO200:TT$(I)="":NEXTI:A=FRE(1):L=0:UB(1)=W0:UB(4)=W9:GOTO940
38000 IFDR$(1)=""ORUB(4)=0THEN920:ELSEW1$=CHR$(UB(1)+192):U=D(8,0):D=D(8,1):X=1:O$="":GOSUB4
38010 OPEN2,U,0,"$"+MID$(STR$(D),2)+":"+W1$+"*":GET#2,A$:GET#2,A$:SYS8258
38020 POKE253,0:SYS8258:IFPEEK(254)THENCLOSE2:GOTO38100
38030 TT$(X)=I$+LEFT$(SP$,20-LEN(I$))+"{white}"+MID$(STR$(PEEK(2975)+256*PEEK(2976)),2)+"{ct h} {yellow}Blocks"
38040 X=X+1:GOTO38020
38100 CLOSE2:IFX=1THENO$=T$(118):GOSUB4:GOTO920:ELSEA$=""
38110 OPEN2,D(10,0),2,MID$(STR$(D(10,1)),2)+":sys.u/d desc"
38120 Y=0:DO:Y=Y+1:W7=INSTR(DR$(Y),W1$):W1=W7:GOSUB8:IFA$=" "THENEXIT
38125 IFA$="{home}"THEN38210
38130 IFW7=0THEN38200:ELSERECORD#2,((Y-1)*120)+W1+12:SYS8222
38140 W2=0:DO:W2=W2+1:IFI$=LEFT$(TT$(W2),INSTR(TT$(W2),",")-1)THENO$="{yellow}   Filename: {white}"+MID$(TT$(W2),2)+"{ct c}":GOSUB4:GOSUB30090:O$=R$:GOSUB9
38145 GOSUB8:IFA$=" "THENEXIT:ELSEIFA$="{home}"THEN38210
38150 LOOPUNTILW2=X-1:IFA$=" "THENEXIT
38160 W7=INSTR(MID$(DR$(Y),W1+1),W1$):W1=W7+W1:GOTO38130
38200 LOOPUNTILY=12:CLOSE2:GOTO940
38210 GOSUB8:IFA$=""ORA$="{home}"THEN38210:ELSEA$="":GOTO38130
55555 A=PEEK(186):OPEN1,A,15,"s0:prg.u/d bases":CLOSE1:SAVE"prg.u/d bases",A
