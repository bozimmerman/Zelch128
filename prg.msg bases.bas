!--------------------------------------------------
!- Monday, May 15, 2017 3:02:46 AM
!- Import of : 
!- c:\src\zelch128\prg.msg bases.prg
!- Commodore 128 BASIC 7/7.1
!--------------------------------------------------
30000 SYS15625:REM ============= MESSAGE BASE MODULE V1.0 ========== 07/26/91 =
30010 ON(W1-100)GOTO30100,30800,32100,34400,34700,35100,35500,37200,37300,38000,38400,38700:GOTO940
30020 OPEN2,D(1,0),2,MID$(STR$(D(1,1)),2)+":sys.msg bases":RETURN
30030 OPEN2,D(1,0),2,MID$(STR$(D(1,1)),2)+":sys.msg data":RETURN
30040 E=0:RECORD#2,W1:FORI=1TO6:SYS8222:NEXTI:W1$=I$:SYS8222:W2$=I$:FORI=8TO10:SYS8222:NEXTI:IFI$=""ORI$="*"THEN30080
30050 IFVAL(I$)THENA$=";"+I$+";":IFINSTR(A$,";"+MID$(STR$(ID),2)+";")THEN30080
30060 X=0:DO:X=X+1:A$=MID$(I$,X,1):Y=ASC(A$)-192:IFY<1THENEXIT
30070 LOOPUNTILMID$(U$(7),Y,1)="1":IFY<1THENE=1:RETURN
30080 IFMID$(W2$,ASC(U$(5))-192,1)<>"1"THENE=1:RETURN:ELSERETURN
30100 GOSUB990:IFM3$<>"*"THENW1=ASC(M3$)-192:GOTO31600:GOTO940:ELSE31500
30200 W1$=I$:GOSUB30020:RECORD#2,M1:INPUT#2,D(7,0):INPUT#2,D(7,1):INPUT#2,M2:SYS8222:SYS8222:SYS8222:M6$=I$:SYS8222:SYS8222
30300 M7$=CHR$(192+M1):M5$=I$:SYS8222:PL(0)=VAL(I$):CLOSE2:O$=T$(56):GOSUB4:F$="sys.sig "+CHR$(M1+64)+" title":U=D(7,0):D=D(7,1):GOSUB26
30350 FORI=1TO50:MN$(I)="0":MR(I)=0:NEXTI:IFINSTR(";"+M5$+";",";"+MID$(STR$(ID),2)+";")ORMID$(U$(8),4,1)="1"THENM5$="{sh @}":ELSEM5$=""
30400 GOSUB30030:RECORD#2,((M1-1)*51)+51:SYS8222:M3=VAL(I$):SYS8222:M4=VAL(I$):X=0:Y=0:IFM3=0THEN30700
30500 FORI=1TOM3:RECORD#2,((M1-1)*51)+I:SYS8222:MN$(I)=I$:SYS8222:MR(I)=VAL(I$):Y=Y+MR(I):IFMN$(I)>U$(6)THENX=X+1
30600 NEXTI:IFX>0THENO$=T$(96):GOSUB4
30700 CLOSE2:O$=T$(97):M5=0:I$=W1$:IFY=1THENMID$(O$,INSTR(O$,"epl")+3,3)="y{ct x*2}":GOSUB4:RETURN:ELSEGOSUB4:RETURN
30800 W3=1:GOSUB990:IFM3$<>"*"THENW3=ASC(M3$)-192
30900 W4=26:GOSUB990:IFM3$<>"*"THENW4=ASC(M3$)-192
31000 GOSUB30020:O$="":GOSUB4:W1=W3-1:DO:W1=W1+1:GOSUB30040
31100 O$="{ct c}":A$=CHR$(W1+192):IFETHEN31400:ELSEO$="{black}"+A$+") "+W1$
31200 IFMID$(U$(10),W1,1)="0"THENO$="{black}"+A$+") [UNJOINED SUB]"
31300 IFW1=M1THENO$=O$+" {white}*"
31400 GOSUB4:GOSUB8:LOOPUNTILW1=W4ORA$=" ":CLOSE2:IFA$=" "THEN920:ELSE940
31500 O$=T$(57):GOSUB4:DO:POKE2831,1:GOSUB8:LOOPUNTILA$=R$OR(ASC(A$)>192ANDASC(A$)<219):O$=A$:GOSUB4:IFA$=R$THEN920:ELSEW1=ASC(A$)-192
31600 GOSUB30020:GOSUB30040:CLOSE2:IFETHEN31700:ELSEM1=W1:O$=O$(10)+":MB"+CHR$(M1+192):GOSUB7:GOSUB30200:GOTO940
31700 O$=T$(58):GOSUB4:GOTO920
31800 GOSUB30030:RECORD#2,((Y-1)*51)+X:PRINT#2,W1$+R$+STR$(W1):CLOSE2:RETURN
31900 GOSUB30030:RECORD#2,((Y-1)*51)+51:PRINT#2,STR$(W1)+R$+STR$(W2):CLOSE2:RETURN
32000 C$="NJAMQ":SYS8210:IFPEEK(252)=1THENGOSUB27:RETURN:ELSERETURN
32100 M8=1:GOSUB990:IFM3=0THEN940:ELSEIFM3$<>"+"THEN32200:ELSEM5=M5+1:IFM5>M3THENO$=T$(59):GOSUB4:M5=M5-1:GOTO940:ELSEGOSUB32400:GOTO940
32200 IFM3$<>"-"THEN32300:ELSEM5=M5-1:IFM5<1THENO$=T$(59):GOSUB4:M5=M5+1:GOTO940:ELSEGOSUB32400:GOTO940
32300 IFM3$<>"*"THEN940:ELSEO$=T$(60):GOSUB4:GOSUB10:IFI<1ORI>M3THEN940:ELSEM5=I:GOSUB32400:GOTO940
32400 W1=MR(M5):IFVAL(MN$(M5))=0THENO$=T$(61):GOSUB4:RETURN
32500 M6=0:U7=0:O$="{ct k}{clear}{yellow}Message #"+MID$(STR$(M5),2):GOSUB4:CLOSE2:OPEN2,D(7,0),2,MID$(STR$(D(7,1)),2)+":msg."+CHR$(M1+64)+STR$(M5)+",s,r":SYS8222:W2$=I$:SYS8222
32600 W4=VAL(I$):GOSUB35070:SYS8222:W3$=I$:SYS8222:W4$=I$:O$="{yellow}Posted by: {white}"+W2$+"{yellow} (ID#{white}"+STR$(W4)+"{yellow}){ct k}At: {white}"+W3$+"{ct k}{yellow}Subject: {white}"+W4$+"{ct k}":GOSUB4:GOSUB32000
32700 CLOSE2:W6$="Continue":IFW1=0THEN37900:ELSEM6=0:M7=0:IFMID$(U$(8),8,1)="1"THEN33000:ELSEO$="{ct k}{black}{ct n}"+STR$(W1)+" Replies":IFW1=1THENMID$(O$,LEN(O$)-2,3)="y  "
32800 GOSUB4:W6$="Replies":GOTO37900
33000 A$="{ct k}{clear}":IFMID$(U$(8),8,1)="1"ANDU7=0THENA$="{ct k}":IFM8=0ANDM6<W1THENM7=1:O$=T$(98):GOSUB4
33050 IFM6ANDI=6THEN33200:ELSECLOSE2:OPEN2,D(7,0),2,MID$(STR$(D(7,1)),2)+":msg."+CHR$(M1+64)+STR$(M5)+",s,r":SYS8213
33100 IFM6>0THENFORI=1TOM6:SYS8213:NEXT
33200 IFM6>=W1THEN33900:ELSESYS8222:IFI$<=U$(6)ANDM7THENSYS8213:M6=M6+1:GOTO33200:ELSESYS8222:W2$=I$:SYS8222:W4=VAL(I$):SYS8222:W3$=I$:GOSUB35070
33300 O$=A$+"{yellow}Message #"+MID$(STR$(M5),2)+", Reply"+STR$(M6+1)+"/"+MID$(STR$(W1),2)+"{ct k}{yellow}Sent by: {white}"+W2$+"{yellow} (ID#{white}"+STR$(W4)+"{yellow}){ct k}At: {white}"+W3$
33310 GOSUB4:GOSUB32000:O$="{black}":GOSUB4:IFPEEK(2859)THENI=INSTR(C$,CHR$(PEEK(2859))):GOTO37980
33400 W6$="Continue":M7=0:W3=M6:M6=M6+1:A$="{ct k}{clear}":IFMID$(U$(8),8,1)="1"ANDU7=0ANDM6<W1THENA$="{ct k}":GOTO33200:ELSE37900
33600 O$=T$(99):GOSUB4:GOSUB10:W3=I-1:IFI$<>R$ANDVAL(I$)=0THENU7=1:GOTO32400:ELSEIFI<1ORI>W1THEN33850
33700 U7=1:I=0:O$=T$(100):GOSUB4:M6=W3:GOTO33000
33800 CLOSE2:A=W4:O(14)=0:GOSUB8080:GOSUB8120
33850 I=0:M7=0:IFM6THENM6=M6-1:GOTO33000:ELSE32400
33900 CLOSE2:O$="{ct k}{black}R)eply,":IFM8=0THENO$=O$+" Q)uit,"
34000 O$=O$+" or (RETURN): {ct c}":GOSUB4:C$="QR"+R$:GOSUB28:O$=A$:GOSUB4:IFI=1THENM8=1:RETURN:ELSEON(I-1)GOTO34100,34300:RETURN
34100 O$=T$(101):GOSUB4:W2$="Reply":GOSUB35050:F$="msg."+CHR$(M1+64)+STR$(M5):GOSUB400:O$(5)=O$(2)+R$+W1$+U$(1)+R$+STR$(ID)+R$+O$(3)
34200 U=D(7,0):D=D(7,1):O(12)=0:GOSUB1000:IFO(11)THENRETURN:ELSEY=M1:X=M5:MN$(X)=O$(2):MR(X)=MR(X)+1:W1$=MN$(X):W1=MR(X):U(2)=U(2)+M(15):GOSUB31800:U(4)=U(4)+1
34300 RETURN
34400 M8=0:IFM3=0THEN940:ELSEM9=1:GOSUB34500:GOTO940
34500 IFMN$(M9)>U$(6)THENM5=M9:GOSUB32400
34600 M9=M9+1:IFM9>M3ORM8=1THENM9=M3:RETURN:ELSE34500
34700 U5=26:GOSUB990:IFM3$<>"*"THENU5=ASC(M3$)-192
34800 M0=M1:M8=0:M9=1:GOSUB34500:GOTO35000
34900 M9=1:IFMID$(U$(10),M0,1)="1"THENW1=M0:GOSUB30020:GOSUB30040:CLOSE2:IFE=0THENM1=M0:GOSUB30200:GOSUB34500
35000 M0=M0+1:IFM0>U5THEN940:ELSEIFM8=1THEN920:ELSE34900
35050 W1$="":IFMID$(O$(22),ASC(U$(5))-192,1)="0"THENRETURN:ELSEO$="{ct k}{black}"+W2$+" anonymously (y/n)? {ct c}":GOSUB4:C$="YN"+R$:GOSUB28:O$=A$:GOSUB4:IFI=1THENW1$="{sh @}"
35060 RETURN
35070 IFLEFT$(W2$,1)<>"{sh @}"ORM5$="{sh @}"THENRETURN:ELSEW2$="*ANONYMOUS*":W4=0:RETURN
35100 GOSUB990:IFPL(M1)>=PL(0)ANDPL(0)>0THENO$=T$(87):GOSUB4:GOTO920:ELSEO$=T$(62):GOSUB4:X=20:GOSUB5:IFI$=""THEN920
35150 U=D(7,0):D=D(7,1):W2$="Post":W3$=I$:GOSUB35050:GOSUB400
35200 F$="msg."+CHR$(M1+64)+STR$(M4):O$(5)=W1$+U$(1)+R$+STR$(ID)+R$+O$(3)+R$+W3$:O(12)=1:GOSUB1000:IFO(11)THEN920:ELSEX=M4:M4=M4+1:IFM4>M2THENM4=1:M3=M2
35300 M3=M3+1:IFM3>M2THENM3=M2
35400 MR(X)=0:MN$(X)=O$(2):Y=M1:W1$=MN$(X):W1=MR(X):GOSUB31800:W1=M3:W2=M4:GOSUB31900:PL(M1)=PL(M1)+1:U(4)=U(4)+1:GOTO940
35500 GOSUB990:IFM3=0THEN940:ELSEIFM3$<>"*"THENM5=VAL(M3$):ELSEO$=T$(63):GOSUB4:GOSUB10:IFI=0ORI>M3THEN940:ELSEM5=I
35510 M8=0:GOSUB35550:DO:GOSUB35600:M5=M5+1:LOOPUNTILM5>M3ORM8=1:GOTO940
35550 O$="{white}{ct k}##  Replies  Posted by                {f7}Date      Time     Subject":GOSUB4:RETURN
35600 IFVAL(MN$(M5))=0THENRETURN
35650 OPEN2,D(7,0),2,MID$(STR$(D(7,1)),2)+":msg."+CHR$(M1+64)+STR$(M5)+",s,r":SYS8222:W2$=I$:SYS8222:W4=VAL(I$):SYS8222:W3$=I$:SYS8222:CLOSE2:GOSUB35070
35700 O$="{black}"+RIGHT$(STR$(M5),2)+"    "+RIGHT$(STR$(MR(M5)),2)+"     "+W2$+" ("+MID$(STR$(W4),2)+")":O$=LEFT$(O$+"                  ",39)+"{f7}"+W3$+"  "+I$
35900 GOSUB4:GOSUB8:IFA$=" "THENM8=1:RETURN:ELSERETURN
36000 IFM6>0THEN36400:ELSEO$=T$(64):GOSUB4:C$="YN":GOSUB28:O$=A$:GOSUB4:IFI=2THEN32400:ELSEMN$(M5)="0":MR(M5)=0:W1$="0":W1=0:Y=M1:X=M5
36100 OPEN1,D(7,0),15,"s"+MID$(STR$(D(7,1)),2)+":msg."+CHR$(M1+64)+STR$(M5):CLOSE1:GOSUB31800:RETURN
36200 IFM6THEN37000:ELSEF$="msg."+CHR$(M1+64)+STR$(M5):U=D(7,0):D=D(7,1):O(12)=2:O(10)=0:O(11)=0:GOSUB8330:E=0:IFMR(M5)=0THENO(12)=1
36300 IFO(11)THENO(11)=0:GOTO32400:ELSEGOSUB1000:GOTO32400
36400 O$=T$(102):GOSUB4:C$="YN":GOSUB28:O$=A$+R$:GOSUB4:IFI=2THEN33000:ELSEO$=T$(103):GOSUB4:CLOSE2:U=D(7,0):D=D(7,1):X=0
36500 OPEN1,U,15,"s"+MID$(STR$(D),2)+":sys.work":OPEN2,U,2,MID$(STR$(D),2)+":msg."+CHR$(M1+64)+STR$(M5)+",s,r":OPEN3,U,3,MID$(STR$(D),2)+":sys.work,s,w"
36600 IFX=M6THENSYS8213:IFPEEK(253)THEN36700
36610 IFX>0THENPRINT#3,CHR$(1)
36620 GOSUB31:X=X+1:IFPEEK(253)THEN36700:ELSE36600
36700 CLOSE2:CLOSE3:INPUT#1,I:IFI>0THENO$="Disk error...":GOSUB4:PRINT#1,"s"+MID$(STR$(D),2)+":sys.work":PRINT#1,"v"+MID$(STR$(D),2):CLOSE1:GOTO33000
36800 PRINT#1,"s"+MID$(STR$(D),2)+":msg."+CHR$(M1+64)+STR$(M5):PRINT#1,"r"+MID$(STR$(D),2)+":msg."+CHR$(M1+64)+STR$(M5)+"=sys.work":CLOSE1
36850 Y=M1:X=M5:MR(X)=MR(X)-1
36900 W1=MR(X):W1$=MN$(X):GOSUB31800:GOTO33000
37000 CLOSE2:F$="msg."+CHR$(M1+64)+STR$(M5):U=D(7,0):D=D(7,1):O(12)=2:O(10)=M6:O(11)=0:GOSUB8330:E=0:IFO(11)THENO(11)=0:GOTO33000:ELSEGOSUB1000:GOTO32400
37200 IFM5$="{sh @}"THEN940:ELSE920
37300 O(12)=1:O(10)=0:F$="sys.sig "+CHR$(M1+64)+" title":U=D(7,0):D=D(7,1):GOSUB8330:O(8)=50:GOSUB1010:GOTO940
37500 A$="":O$="{black}J)ump, A)gain, M)ail,":IFW1ANDM8ANDM6=0THENO$=O$+" N)ew,"
37600 IFM5$="{sh @}"ORW4=IDTHENO$=O$+" K)ill,":A$="KE"
37700 O$=O$+"{f7}":IFA$<>""THENO$=O$+"E)dit, "
37800 O$=O$+"Q)uit, (RETURN = "+W6$+"): {ct c}":C$="NJAMQ"+R$+A$:RETURN
37900 GOSUB37500:GOSUB4:GOSUB28:O$="":IFA$<>R$THENO$=A$
37950 GOSUB4:IFI=6ANDW1=0THEN33900:ELSEIFM6=0ANDW1THENIF(I=1)OR(M8=0ANDI=6)THENO$=T$(98):GOSUB4:M7=1:GOTO33000
37980 ONIGOTO33000,33600,33850,33800,33900,33000,36000,36200:GOTO940
38000 MID$(U$(10),M1,1)=RIGHT$(STR$(ABS(VAL(MID$(U$(10),M1,1))-1)),1):O$="{ct k}"+M6$+" has been "+MID$("droppedjoined ",VAL(MID$(U$(10),M1,1))*7+1,7)
38010 GOSUB4:GOTO940
38400 M8=0:IFM3=0THEN940:ELSEM9=1:GOSUB35550:GOSUB38500:GOTO940
38500 IFMN$(M9)>U$(6)THENM5=M9:GOSUB35600
38600 M9=M9+1:IFM9>M3ORM8=1THENM9=M3:RETURN:ELSE38500
38700 MID$(U$(8),8,1)=RIGHT$(STR$(ABS(VAL(MID$(U$(8),8,1))-1)),1):A$="Non-":IFMID$(U$(8),8,1)="1"THENA$=""
38800 O$="{ct k}{black}You're now in "+A$+"continuous read mode.":GOSUB4:GOTO940
55555 A=PEEK(186):OPEN1,A,15,"s0:prg.msg bases":CLOSE1:SAVE"prg.msg bases",A
